<link rel="stylesheet" type="text/css" href="/ui/modModules/repoManager/repoManager.css" />

<div class="repomanager-container">
  <div class="repomanager-header">
    <h2>Repo Manager</h2>
    <p>Manage your dependency packs and mods</p>

    <!-- Bulk action buttons in header -->
    <div class="header-buttons">
      <button class="header-install-btn" ng-click="installAllPacks()" ng-disabled="!hasPacksToInstall()">
        <span>Queue All Packs</span>
        <small>Start first pack and queue the rest</small>
      </button>
      <button class="header-uninstall-btn" ng-click="uninstallAllPacks()">
        <span>Deactivate All Packs</span>
        <small>Disable all dependency packs</small>
      </button>
    </div>
  </div>

  <div class="repomanager-content" ng-if="loading">
    <div class="loading-spinner">
      <p>Loading mod packs...</p>
    </div>
  </div>

  <!-- Scrollable Collections Grid -->
  <div class="collections-grid-container">
    <div class="repomanager-content" ng-if="!loading">
      <!-- Currently Downloading Section -->
      <div class="currently-downloading-section" ng-if="getCurrentlyDownloadingPack()">
        <div class="download-header">
          <h3>Currently Downloading</h3>
          <div class="download-pack-info">
            <span class="pack-name">{{getCurrentlyDownloadingPack() && getCurrentlyDownloadingPack().pack &&
              getCurrentlyDownloadingPack().pack.name}}</span>
            <span class="pack-progress">{{getCurrentProgressCount()}}/{{getCurrentlyDownloadingPack() &&
              getCurrentlyDownloadingPack().progress && getCurrentlyDownloadingPack().progress.totalMods}} mods</span>
          </div>
        </div>

        <div class="downloading-mods-grid"
          ng-if="currentDownloadPack && currentDownloadPack.progress && currentDownloadPack.progress.downloadingMods && currentDownloadPack.progress.downloadingMods.length > 0">
          <div class="downloading-mod-item" ng-repeat="mod in currentDownloadPack.progress.downloadingMods track by $index">
            <div class="mod-info-header">
              <span class="mod-name">{{getModDisplayName(mod)}}</span>
              <span class="mod-size">{{formatModFileSize(mod.dlnow)}}/{{formatModFileSize(mod.dltotal)}}</span>
            </div>
            <div class="mod-progress-container">
              <div class="mod-progress-bar-large">
                <div class="mod-progress-fill-large" ng-style="{'width': mod.progress + '%'}"></div>
              </div>
              <div class="mod-progress-percentage">{{mod.progress}}%</div>
            </div>
            <div class="mod-download-details" ng-if="mod.downloadSpeed > 0">
              <span class="download-speed">{{formatDownloadSpeed(mod.downloadSpeed)}}</span>
            </div>
          </div>
        </div>

        <div class="no-downloads-message" ng-if="shouldShowPreparingDownloads()">
          <p>{{getPreparingDownloadsMessage()}}</p>
        </div>



        <!-- Queue Display -->
        <div class="queue-display" ng-if="packQueue.length > 0">
          <div class="queue-header">
            <h4>Up Next</h4>
            <span class="queue-count">{{packQueue.length}} pack{{packQueue.length > 1 ? 's' : ''}} queued</span>
          </div>
          <div class="queue-items">
            <div class="queue-item" ng-repeat="queuedPackName in packQueue track by $index">
              <span class="queue-position">{{$index + 1}}.</span>
              <span class="queue-pack-name">{{(dependencies | filter:{packName: queuedPackName})[0] && (dependencies |
                filter:{packName: queuedPackName})[0].name || queuedPackName}}</span>
              <button class="remove-queue-btn"
                ng-click="removeFromQueue((dependencies | filter:{packName: queuedPackName})[0] && (dependencies | filter:{packName: queuedPackName})[0].id)"
                title="Remove from queue" ng-if="(dependencies | filter:{packName: queuedPackName})[0]">×</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Mod Sections -->
      <div class="mod-sections" ng-repeat="section in modSections">
        <div class="section-header" ng-click="toggleSection(section.modName)">
          <div class="section-title">
            <span class="section-arrow" ng-class="{'expanded': isSectionExpanded(section.modName)}">▶</span>
            <h3>{{ section.modName }}</h3>
            <span class="pack-count">({{ (section.packs | filter:{isCreatePack: '!true'}).length }} pack{{ (section.packs | filter:{isCreatePack: '!true'}).length !== 1 ? 's' : '' }})</span>
          </div>
          <div class="section-status">
            <span class="status-badge" ng-class="getSectionStatus(section).class">
              {{ getSectionStatus(section).text }}
            </span>
          </div>
        </div>
        
        <div class="section-actions" ng-if="isSectionExpanded(section.modName)">
          <button class="section-action-btn queue-all-btn" 
                  ng-click="queueAllPacksInSection(section)" 
                  ng-disabled="!canQueueSection(section)">
            Queue All Packs
          </button>
          <button class="section-action-btn deactivate-all-btn" 
                  ng-click="deactivateAllPacksInSection(section)" 
                  ng-disabled="!canDeactivateSection(section)">
            Deactivate All Packs
          </button>
        </div>
        
        <div class="collections-grid" ng-if="isSectionExpanded(section.modName)">
          <div class="collection-card" ng-repeat="pack in section.packs"
            ng-class="{'disabled': !enabledPacks[pack.id], 'downloading': currentPack === pack.packName}">
            <div class="card-image-container">
              <img ng-src="{{pack.imagePath}}" alt="{{pack.name}}" class="pack-image"
                onerror="this.src='/ui/modModules/repoManager/icons/repoManagerIcon.png'">
              <div class="pack-status" ng-class="getPackStatusState(pack).class">
                <span>{{getPackStatusState(pack).text}}</span>
              </div>

              <!-- Simple Progress Overlay -->
              <div class="progress-overlay" ng-if="currentPack === pack.packName">
                <div class="download-summary">
                  <div class="summary-text">
                    Downloading: {{getCurrentProgressCount()}}/{{packModCount}} mods
                  </div>
                </div>
              </div>
            </div>

            <div class="card-content">
              <div class="pack-header">
                <h3>{{ pack.name }}</h3>
                <div class="mod-count-container" ng-if="!pack.isCreatePack">
                  <span class="mod-count" ng-if="!packStatuses[pack.packName]">{{ pack.count }} mods</span>
                  <span class="mod-count pending"
                    ng-if="packStatuses[pack.packName] && packStatuses[pack.packName].isPending">
                    {{ packStatuses[pack.packName].totalCount }} mods pending
                  </span>
                  <span class="mod-count active"
                    ng-if="packStatuses[pack.packName] && !packStatuses[pack.packName].isPending && packStatuses[pack.packName].activeCount > 0">
                    {{ packStatuses[pack.packName].activeCount }}/{{ packStatuses[pack.packName].totalCount }} active
                  </span>
                  <span class="mod-count inactive"
                    ng-if="packStatuses[pack.packName] && !packStatuses[pack.packName].isPending && packStatuses[pack.packName].activeCount === 0">
                    0/{{ packStatuses[pack.packName].totalCount }} active
                  </span>
                </div>
              </div>

              <div class="pack-description">
                <p>{{pack.description}}</p>
              </div>

              <div class="pack-actions">
                <button ng-click="togglePack(pack)" class="toggle-btn" ng-class="getPackButtonState(pack).class"
                  ng-disabled="getPackButtonState(pack).disabled">
                  <span>{{getPackButtonState(pack).text}}</span>
                </button>
                
                <!-- Regular pack details button -->
                <button class="details-btn" ng-click="showPackDetails(pack)" ng-if="!pack.isCreatePack && !isCustomPack(pack)">Details</button>
                
                <!-- Custom pack management buttons -->
                <div ng-if="isCustomPack(pack)" class="custom-pack-actions">
                  <button class="edit-pack-btn" ng-click="editCustomPack(pack)" title="Edit Pack">
                    <span>Edit</span>
                  </button>
                  <button class="delete-pack-btn" ng-click="deleteCustomPack(pack)" title="Delete Pack">
                    <span>Delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="repomanager-buttons">
    <button ng-click="goBack()">Back to Main Menu</button>
  </div>
</div>

<!-- Pack Details Modal -->
<div class="pack-details-modal" ng-show="showDetailsModal">
  <div class="modal-backdrop" ng-click="closePackDetails()"></div>
  <div class="modal-content pack-details-content">
    <div class="modal-header">
      <h2>{{ selectedPack.name }} - Pack Details</h2>
      <button class="close-btn" ng-click="closePackDetails()">×</button>
    </div>

    <div class="modal-body">
      <!-- Pack Information Section -->
      <div class="pack-form-section">
        <div class="pack-details-info">
          <div class="pack-detail-item">
            <span class="detail-label">Description:</span>
            <span class="detail-value">{{ selectedPack.description }}</span>
          </div>
          <div class="pack-detail-item">
            <span class="detail-label">Total Mods:</span>
            <span class="detail-value">{{ selectedPack.count }}</span>
          </div>
          <div class="pack-detail-item">
            <span class="detail-label">Pack Status:</span>
            <span class="detail-value" ng-class="getPackStatusState(selectedPack).class">{{ getPackStatusState(selectedPack).text }}</span>
          </div>
          <div class="pack-detail-item" ng-if="packStatuses[selectedPack.packName]">
            <span class="detail-label">Active Mods:</span>
            <span class="detail-value">{{ packStatuses[selectedPack.packName].activeCount || 0 }}/{{ packStatuses[selectedPack.packName].totalCount || selectedPack.count }}</span>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-mods" ng-show="loadingPackDetails">
        <p>Loading mod details... ({{ loadedModsCount }}/{{ modsPerPage }})</p>
        <div class="loading-spinner"></div>
      </div>

      <!-- Mods Section -->
      <div class="pack-mods-section" ng-show="!loadingPackDetails">
        <!-- Pagination Controls -->
        <div class="pagination-controls" ng-show="totalPages > 1">
          <button class="page-btn" ng-click="previousPage()" ng-disabled="currentPage === 1">
            ← Previous
          </button>
          
          <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
          
          <button class="page-btn" ng-click="nextPage()" ng-disabled="currentPage === totalPages">
            Next →
          </button>
        </div>

        <!-- Mods Grid -->
        <div class="create-pack-mods-grid">
          <div class="create-pack-mod-card pack-detail-mod-card" ng-repeat="mod in packModDetails">
            <div class="mod-icon-container">
              <img ng-src="{{ getModIcon(mod) }}" 
                   class="mod-icon"
                   onerror="this.src='/ui/modModules/repoManager/icons/default-mod-icon.png'">
            </div>
            
            <div class="mod-basic-info">
              <div class="mod-name">{{ mod.title }}</div>
              <div class="mod-author" ng-if="mod.author">By: {{ mod.author || 'Unknown' }}</div>
              <div class="mod-description-mini">{{ mod.tag_line }}</div>
            </div>
            
            <!-- Info Button for detailed mod information -->
            <div class="mod-info-button" ng-click="openModInfo(mod, $event)" title="View detailed mod information">
              <span class="info-icon">ⓘ</span>
            </div>
            
            <!-- Mod Stats -->
            <div class="mod-stats-section">
              <div class="mod-status repo-mod-stats">
                <span class="downloads" ng-if="mod.downTxt">{{ mod.downTxt }} downloads</span>
                <span class="rating" ng-if="mod.rating_avg > 0">★ {{ mod.rating_avg }}</span>
                <span class="filesize" ng-if="mod.filesize_display">{{ mod.filesize_display }}</span>
              </div>
            </div>
            
                         <!-- Action Buttons -->
             <div class="mod-detail-actions">
               <!-- If mod is not installed locally, show subscribe button -->
               <button class="mod-action-btn subscribe-btn" ng-if="!isModInstalledLocally(mod)"
                 ng-click="subscribeToMod(mod)" title="Subscribe to download this mod">
                 Subscribe
               </button>
               
               <!-- If mod is installed locally, show activate/deactivate and unsubscribe -->
               <button class="mod-action-btn activate-btn" ng-if="isModInstalledLocally(mod) && !isModActive(mod)"
                 ng-click="activateMod(mod)" title="Activate this mod">
                 Activate
               </button>
               <button class="mod-action-btn deactivate-btn" ng-if="isModInstalledLocally(mod) && isModActive(mod)"
                 ng-click="deactivateMod(mod)" title="Deactivate this mod">
                 Deactivate
               </button>
               <button class="mod-action-btn unsubscribe-btn" ng-if="isModInstalledLocally(mod)"
                 ng-click="unsubscribeFromMod(mod)" title="Unsubscribe and remove this mod">
                 Unsubscribe
               </button>
             </div>
          </div>
        </div>
        
        <!-- Bottom Pagination -->
        <div class="pagination-controls" ng-show="totalPages > 1">
          <button class="page-btn" ng-click="previousPage()" ng-disabled="currentPage === 1">
            ← Previous
          </button>
          
          <span class="page-info">Page {{ currentPage }} of {{ totalPages }}</span>
          
          <button class="page-btn" ng-click="nextPage()" ng-disabled="currentPage === totalPages">
            Next →
          </button>
        </div>

        <!-- No Mods Message -->
        <div class="no-mods-found" ng-show="packModDetails.length === 0 && !loadingPackDetails">
          <p>No mod details available for this pack.</p>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="footer-info">
        <span>{{ selectedPack.name }} - {{ selectedPack.count }} total mods</span>
      </div>
      <div class="footer-actions">
        <button class="cancel-btn" ng-click="closePackDetails()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Create Pack Modal -->
<div class="create-pack-modal" ng-show="showCreatePackModal">
  <div class="modal-backdrop" ng-click="cancelCreatePack()"></div>
  <div class="modal-content create-pack-content">
    <div class="modal-header">
      <h2>{{ editingPack ? 'Edit Custom Pack' : 'Create Custom Pack' }}</h2>
      <button class="close-btn" ng-click="cancelCreatePack()">×</button>
    </div>

    <div class="modal-body">
      <!-- Pack Information Form -->
      <div class="pack-form-section">
        <div class="form-group">
          <label for="packName">Pack Name *</label>
          <input type="text" id="packName" ng-model="createPackForm.name" placeholder="Enter pack name" maxlength="50" required>
        </div>
        
        <div class="form-group">
          <label for="packDescription">Description</label>
          <textarea id="packDescription" ng-model="createPackForm.description" placeholder="Enter pack description" maxlength="200"></textarea>
        </div>
        
        <div class="form-group">
          <label for="packOrder">Order (Priority)</label>
          <input type="number" id="packOrder" ng-model="createPackForm.order" placeholder="999" min="0" max="999" step="1">
        </div>
        
        <div class="selected-mods-summary">
          <span class="selected-count">Selected Mods: {{ getSelectedModCount() }}</span>
        </div>
      </div>
      
      <!-- Tab Navigation -->
      <div class="create-pack-tabs">
        <button class="tab-btn" ng-class="{active: createPackActiveTab === 'local'}" ng-click="switchCreatePackTab('local')">Local Mods</button>
        <button class="tab-btn" ng-class="{active: createPackActiveTab === 'repo'}" ng-click="switchCreatePackTab('repo')">Repository</button>
        <button class="tab-btn" ng-class="{active: createPackActiveTab === 'selected'}" ng-click="switchCreatePackTab('selected')">Selected ({{ getSelectedModCount() }})</button>
      </div>

      <!-- Loading State -->
      <div class="loading-mods" ng-show="loadingAllMods">
        <p>Loading available mods...</p>
        <div class="loading-spinner"></div>
      </div>

      <!-- Local Mods Tab Content -->
      <div class="mod-selection-section" ng-show="!loadingAllMods && createPackActiveTab === 'local'">
        <!-- Local Mods Filters -->
        <div class="local-mods-filters">
          <!-- Main Search Bar -->
          <div class="filter-section">
            <input type="text" ng-model="createPackFilter" ng-change="filterMods()" 
                   placeholder="Search mods by title, name, author, or ID..." class="filter-input">
          </div>
          
          <!-- Filter Controls Row -->
          <div class="local-filter-controls-row">
            <div class="local-results-info">
              <span class="filter-results">{{ filteredMods.length }} mod{{ filteredMods.length !== 1 ? 's' : '' }} found</span>
            </div>
            
            <div class="local-controls">
              <!-- Mod Type Toggles -->
              <div class="mod-type-filters-inline">
                <div class="mod-type-toggles">
                  <button class="mod-type-toggle" ng-class="{'active': isModTypeEnabled('local')}" ng-click="toggleModTypeFilter('local')">
                    Local ({{ getModTypeCount('local') }})
                  </button>
                  <button class="mod-type-toggle" ng-class="{'active': isModTypeEnabled('unpacked')}" ng-click="toggleModTypeFilter('unpacked')">
                    Unpacked ({{ getModTypeCount('unpacked') }})
                  </button>
                  <button class="mod-type-toggle" ng-class="{'active': isModTypeEnabled('repo')}" ng-click="toggleModTypeFilter('repo')">
                    Repository ({{ getModTypeCount('repo') }})
                  </button>
                </div>
              </div>
              
              <!-- Mods Per Page Dropdown -->
              <div class="mods-per-page-control">
                <label>Show:</label>
                <div class="custom-dropdown">
                  <div class="dropdown-selected" ng-click="showLocalModsPerPageDropdown = !showLocalModsPerPageDropdown">
                    <span>{{ createPackModsPerPage }}</span>
                    <span class="dropdown-arrow">▼</span>
                  </div>
                  <div class="dropdown-options" ng-show="showLocalModsPerPageDropdown">
                    <div class="dropdown-option" ng-click="createPackModsPerPage = 10; showLocalModsPerPageDropdown = false; updateModsPagination()">10</div>
                    <div class="dropdown-option" ng-click="createPackModsPerPage = 20; showLocalModsPerPageDropdown = false; updateModsPagination()">20</div>
                    <div class="dropdown-option" ng-click="createPackModsPerPage = 50; showLocalModsPerPageDropdown = false; updateModsPagination()">50</div>
                    <div class="dropdown-option" ng-click="createPackModsPerPage = 100; showLocalModsPerPageDropdown = false; updateModsPagination()">100</div>
                  </div>
                </div>
                <span>per page</span>
              </div>
              
              <!-- Pack Exclusion Control -->
              <div class="pack-exclusion-controls">
                <button class="pack-exclusion-toggle-btn" ng-click="togglePackExclusionFilter()">
                  Exclude from Packs ({{ excludedPacks.length }})
                  <span class="dropdown-arrow" ng-class="{'expanded': showPackExclusionFilter}">▼</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Pack Exclusion Filter Dropdown -->
          <div class="pack-exclusion-filter-dropdown" ng-show="showPackExclusionFilter">
            <div class="pack-exclusion-actions">
              <button class="pack-exclusion-action-btn" ng-click="selectAllPacksForExclusion()">Select All</button>
              <button class="pack-exclusion-action-btn" ng-click="clearAllPackExclusions()">Clear All</button>
              <button class="pack-exclusion-apply-btn" ng-click="applyPackExclusionFilter()">Apply</button>
            </div>
            <div class="pack-exclusion-grid">
              <div class="pack-exclusion-item" ng-repeat="pack in availablePacksForExclusion">
                <label>
                  <input type="checkbox" ng-checked="isPackExcluded(pack.packName)" ng-click="togglePackExclusion(pack.packName)">
                  <div class="pack-info">
                    <div class="pack-name">{{ pack.name }}</div>
                    <div class="pack-mod-count">({{ pack.count }} mods)</div>
                  </div>
                </label>
              </div>
            </div>
            <div class="no-packs-message" ng-show="availablePacksForExclusion.length === 0">
              <p>No dependency packs available to exclude from.</p>
            </div>
          </div>
        </div>

        <!-- Pagination for Mods -->
        <div class="pagination-controls" ng-show="createPackTotalPages > 1">
          <button class="page-btn" ng-click="previousCreatePackPage()" ng-disabled="createPackCurrentPage === 1">
            ← Previous
          </button>
          
          <span class="page-info">Page {{ createPackCurrentPage }} of {{ createPackTotalPages }}</span>
          
          <button class="page-btn" ng-click="nextCreatePackPage()" ng-disabled="createPackCurrentPage === createPackTotalPages">
            Next →
          </button>
        </div>

        <!-- Mods Grid -->
        <div class="create-pack-mods-grid">
          <div class="create-pack-mod-card" ng-repeat="mod in getPagedMods()" ng-class="{'selected': isModSelected(mod)}" ng-click="toggleModSelection(mod)">
            <div class="mod-selection-checkbox">
              <input type="checkbox" ng-checked="isModSelected(mod)" disabled>
            </div>
            
            <div class="mod-icon-container">
              <img ng-src="{{ mod.iconPath || '/ui/modModules/repoManager/icons/default-mod-icon.png' }}" 
                   class="mod-icon"
                   onerror="this.src='/ui/modModules/repoManager/icons/default-mod-icon.png'">
            </div>
            
            <div class="mod-basic-info">
              <div class="mod-name">{{ mod.title || mod.name || mod.modname }}</div>
              <div class="mod-author" ng-if="mod.author">By: {{ mod.author }}</div>
              <div class="mod-status" ng-class="{'active': mod.active, 'inactive': !mod.active}">
                {{ mod.active ? 'Active' : 'Inactive' }}
              </div>
            </div>
            
            <!-- Info Button for mods with repository data -->
            <div class="mod-info-button" ng-if="mod.tagid" ng-click="openModInfo(mod, $event)" title="View detailed mod information">
              <span class="info-icon">ⓘ</span>
            </div>
            
            <!-- Info section for local mods -->
            <div class="mod-info-section">
              <!-- Repository info for local mods with tagid -->
              <div class="mod-stats repo-mod-stats" ng-if="hasRepoInfo(mod)">
                <span ng-repeat="info in getRepoInfoDisplay(mod)" class="repo-info-item">{{ info }}</span>
              </div>
              <!-- Local mod stats for mods without repo info -->
              <div class="mod-stats local-mod-stats" ng-if="!hasRepoInfo(mod) && (mod.filesize || mod.download_count)">
                <span class="filesize" ng-if="mod.filesize">{{ formatFileSize(mod.filesize) }}</span>
                <span class="downloads" ng-if="mod.download_count">{{ mod.download_count }} downloads</span>
              </div>
              <!-- Mod type badge -->
              <div class="mod-type-badge" ng-class="getModType(mod)">
                {{ getModType(mod) | uppercase }}
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom Pagination for Local Mods -->
        <div class="pagination-controls" ng-show="createPackTotalPages > 1">
          <button class="page-btn" ng-click="previousCreatePackPage()" ng-disabled="createPackCurrentPage === 1">
            ← Previous
          </button>
          
          <span class="page-info">Page {{ createPackCurrentPage }} of {{ createPackTotalPages }}</span>
          
          <button class="page-btn" ng-click="nextCreatePackPage()" ng-disabled="createPackCurrentPage === createPackTotalPages">
            Next →
          </button>
        </div>

        <!-- No Mods Found -->
        <div class="no-mods-found" ng-show="filteredMods.length === 0 && !loadingAllMods">
          <p>No mods found matching your search criteria.</p>
        </div>
      </div>
      
      <!-- Repository Tab Content -->
      <div class="repo-selection-section" ng-show="createPackActiveTab === 'repo'">
        <!-- Repository Filters - Always Visible -->
        <div class="repo-filters">
          <!-- Main Search Bar -->
          <div class="filter-section">
            <input type="text" ng-model="repoFilter.query" placeholder="Search repository mods by title, author, or description..." class="filter-input">
            <button class="search-btn" ng-click="applyRepoFilters()">Search</button>
          </div>
          
          <!-- Filter Controls Row -->
          <div class="repo-filter-controls-row">
            <div class="sort-controls">
              <label>Sort by:</label>
              
              <!-- Custom Sort By Dropdown -->
              <div class="custom-dropdown">
                <div class="dropdown-selected" ng-click="showSortByDropdown = !showSortByDropdown">
                  <span>{{ repoFilter.orderBy === 'downloads' ? 'Downloads' : repoFilter.orderBy === 'rating' ? 'Rating' : repoFilter.orderBy === 'update' ? 'Last Updated' : 'Name' }}</span>
                  <span class="dropdown-arrow">▼</span>
                </div>
                <div class="dropdown-options" ng-show="showSortByDropdown">
                  <div class="dropdown-option" ng-click="repoFilter.orderBy = 'downloads'; showSortByDropdown = false; applyRepoFilters()">Downloads</div>
                  <div class="dropdown-option" ng-click="repoFilter.orderBy = 'rating'; showSortByDropdown = false; applyRepoFilters()">Rating</div>
                  <div class="dropdown-option" ng-click="repoFilter.orderBy = 'update'; showSortByDropdown = false; applyRepoFilters()">Last Updated</div>
                  <div class="dropdown-option" ng-click="repoFilter.orderBy = 'name'; showSortByDropdown = false; applyRepoFilters()">Name</div>
                </div>
              </div>
              
              <!-- Custom Order Dropdown -->
              <div class="custom-dropdown">
                <div class="dropdown-selected" ng-click="showOrderDropdown = !showOrderDropdown">
                  <span>{{ repoFilter.order === 'desc' ? 'Descending' : 'Ascending' }}</span>
                  <span class="dropdown-arrow">▼</span>
                </div>
                <div class="dropdown-options" ng-show="showOrderDropdown">
                  <div class="dropdown-option" ng-click="repoFilter.order = 'desc'; showOrderDropdown = false; applyRepoFilters()">Descending</div>
                  <div class="dropdown-option" ng-click="repoFilter.order = 'asc'; showOrderDropdown = false; applyRepoFilters()">Ascending</div>
                </div>
              </div>
            </div>
            
            <div class="category-controls">
              <button class="category-toggle-btn" ng-click="showCategoryFilter = !showCategoryFilter">
                Categories ({{ repoFilter.categories.length }})
                <span class="dropdown-arrow" ng-class="{'expanded': showCategoryFilter}">▼</span>
              </button>
            </div>
          </div>
          
          <!-- Category Filter Dropdown -->
          <div class="category-filter-dropdown" ng-show="showCategoryFilter">
            <div class="category-actions">
              <button class="cat-action-btn" ng-click="selectAllCategories()">Select All</button>
              <button class="cat-action-btn" ng-click="clearAllCategories()">Clear All</button>
              <button class="cat-apply-btn" ng-click="applyRepoFilters()">Apply</button>
            </div>
            <div class="category-grid">
              <div class="category-item" ng-repeat="category in repoCategories">
                <label>
                  <input type="checkbox" ng-checked="isCategorySelected(category.value)" ng-click="toggleCategory(category.value)">
                  {{ category.name }}
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Repository Mods Section -->
        <div class="repo-mods-section">
          <!-- Pagination Controls - Always Visible -->
          <div class="pagination-controls" ng-show="repoTotalPages > 1">
            <button class="page-btn" ng-click="previousRepoPage()" ng-disabled="repoCurrentPage === 1">
              ← Previous
            </button>
            
            <span class="page-info">Page {{ repoCurrentPage }} of {{ repoTotalPages }}</span>
            
            <button class="page-btn" ng-click="nextRepoPage()" ng-disabled="repoCurrentPage === repoTotalPages">
              Next →
            </button>
          </div>
          
          <!-- Repository Loading State - Only for mod grid -->
          <div class="loading-mods" ng-show="loadingRepoMods">
            <p>Loading repository mods...</p>
            <div class="loading-spinner"></div>
          </div>
          
          <!-- Unified Mods Grid (same as local mods) -->
          <div class="create-pack-mods-grid" ng-show="!loadingRepoMods">
            <div class="create-pack-mod-card" ng-repeat="mod in getRepoPagedMods()" ng-class="{'selected': isRepoModSelected(mod)}" ng-click="toggleRepoModSelection(mod)">
              <div class="mod-selection-checkbox">
                <input type="checkbox" ng-checked="isRepoModSelected(mod)" disabled>
              </div>
              
              <div class="mod-icon-container">
                <img ng-src="{{ getModIcon(mod) }}" 
                     class="mod-icon"
                     onerror="this.src='/ui/modModules/repoManager/icons/default-mod-icon.png'">
              </div>
              
              <div class="mod-basic-info">
                <div class="mod-name">{{ mod.title }}</div>
                <div class="mod-author" ng-if="mod.author">By: {{ mod.author }}</div>
              </div>
              
              <!-- Info Button with stats positioned underneath -->
              <div class="mod-info-button" ng-click="openModInfo(mod, $event)" title="View detailed mod information">
                <span class="info-icon">ⓘ</span>
              </div>
              
              <div class="mod-stats-section">
                <div class="mod-status repo-mod-stats">
                  <span class="downloads">{{ mod.downTxt }} downloads</span>
                  <span class="rating" ng-if="mod.rating_avg > 0">★ {{ mod.rating_avg }}</span>
                  <span class="filesize">{{ mod.filesize_display }}</span>
                </div>
              </div>
              
                             <!-- Action Buttons for Repository Mods -->
               <div class="mod-detail-actions" style="position: absolute; bottom: 12px; left: 8px; right: 8px;">
                 <!-- If mod is not installed locally, show subscribe button -->
                 <button class="mod-action-btn subscribe-btn" ng-if="!isModInstalledLocally(mod)"
                   ng-click="subscribeToMod(mod)" title="Subscribe to download this mod">
                   Subscribe
                 </button>
                 
                 <!-- If mod is installed locally, show activate/deactivate and unsubscribe -->
                 <button class="mod-action-btn activate-btn" ng-if="isModInstalledLocally(mod) && !isModActive(mod)"
                   ng-click="activateMod(mod)" title="Activate this mod">
                   Activate
                 </button>
                 <button class="mod-action-btn deactivate-btn" ng-if="isModInstalledLocally(mod) && isModActive(mod)"
                   ng-click="deactivateMod(mod)" title="Deactivate this mod">
                   Deactivate
                 </button>
                 <button class="mod-action-btn unsubscribe-btn" ng-if="isModInstalledLocally(mod)"
                   ng-click="unsubscribeFromMod(mod)" title="Unsubscribe and remove this mod">
                   Unsubscribe
                 </button>
               </div>
            </div>
          </div>
          
          <!-- Bottom Pagination Controls - Same as top -->
          <div class="pagination-controls" ng-show="repoTotalPages > 1 && !loadingRepoMods">
            <button class="page-btn" ng-click="previousRepoPage()" ng-disabled="repoCurrentPage === 1">
              ← Previous
            </button>
            
            <span class="page-info">Page {{ repoCurrentPage }} of {{ repoTotalPages }}</span>
            
            <button class="page-btn" ng-click="nextRepoPage()" ng-disabled="repoCurrentPage === repoTotalPages">
              Next →
            </button>
          </div>
          
          <!-- No Repository Mods Found -->
          <div class="no-mods-found" ng-show="getRepoPagedMods().length === 0 && !loadingRepoMods">
            <p>No repository mods found. Try adjusting your search or category filters.</p>
            <p ng-if="!isOnlineEnabled()">Online features may be disabled or you may not be authenticated.</p>
          </div>
        </div>
      </div>
      
      <!-- Selected Mods Tab Content -->
      <div class="selected-mods-section" ng-show="createPackActiveTab === 'selected'">
        <!-- Filter Input for Selected Mods -->
        <div class="filter-section">
          <input type="text" ng-model="selectedModsFilter" ng-change="filterSelectedMods()" 
                 placeholder="Search selected mods by title, name, author, or ID..." class="filter-input">
          <div class="filter-controls-row">
            <span class="filter-results">{{ filteredSelectedMods.length }} selected mod{{ filteredSelectedMods.length !== 1 ? 's' : '' }} found</span>
            
            <!-- Mods Per Page Dropdown for Selected -->
            <div class="mods-per-page-control">
              <label>Show:</label>
              <div class="custom-dropdown">
                <div class="dropdown-selected" ng-click="showSelectedModsPerPageDropdown = !showSelectedModsPerPageDropdown">
                  <span>{{ selectedModsPerPage }}</span>
                  <span class="dropdown-arrow">▼</span>
                </div>
                <div class="dropdown-options" ng-show="showSelectedModsPerPageDropdown">
                  <div class="dropdown-option" ng-click="selectedModsPerPage = 10; showSelectedModsPerPageDropdown = false; updateSelectedModsPagination()">10</div>
                  <div class="dropdown-option" ng-click="selectedModsPerPage = 20; showSelectedModsPerPageDropdown = false; updateSelectedModsPagination()">20</div>
                  <div class="dropdown-option" ng-click="selectedModsPerPage = 50; showSelectedModsPerPageDropdown = false; updateSelectedModsPagination()">50</div>
                </div>
              </div>
              <span>per page</span>
            </div>
          </div>
        </div>

        <!-- Pagination for Selected Mods -->
        <div class="pagination-controls" ng-show="selectedModsTotalPages > 1">
          <button class="page-btn" ng-click="previousSelectedModsPage()" ng-disabled="selectedModsCurrentPage === 1">
            ← Previous
          </button>
          
          <span class="page-info">Page {{ selectedModsCurrentPage }} of {{ selectedModsTotalPages }}</span>
          
          <button class="page-btn" ng-click="nextSelectedModsPage()" ng-disabled="selectedModsCurrentPage === selectedModsTotalPages">
            Next →
          </button>
        </div>

        <!-- Selected Mods Grid -->
        <div class="create-pack-mods-grid">
          <div class="create-pack-mod-card selected-mod-card" ng-repeat="mod in getPagedSelectedMods()" ng-click="removeModFromSelection(mod)">
            <div class="mod-selection-checkbox selected">
              <input type="checkbox" checked disabled>
            </div>
            
            <div class="mod-icon-container">
              <img ng-src="{{ getModIcon(mod) }}" 
                   class="mod-icon"
                   onerror="this.src='/ui/modModules/repoManager/icons/default-mod-icon.png'">
            </div>
            
            <div class="mod-basic-info">
              <div class="mod-name">{{ mod.title || mod.name || mod.modname }}</div>
              <div class="mod-author" ng-if="mod.author">By: {{ mod.author }}</div>
              <div class="mod-source-info">
                <span class="mod-source-badge" ng-class="{'local-source': !mod.tagid, 'repo-source': mod.tagid}">
                  {{ mod.tagid ? 'Repository' : 'Local' }}
                </span>
              </div>
            </div>
            
            <!-- Remove button -->
            <div class="mod-remove-button" ng-click="removeModFromSelection(mod); $event.stopPropagation()" title="Remove from pack">
              <span class="remove-icon">×</span>
            </div>
            
            <!-- Stats section -->
            <div class="mod-stats-section" ng-if="mod.tagid">
              <div class="mod-status repo-mod-stats">
                <span class="downloads" ng-if="mod.downTxt">{{ mod.downTxt }} downloads</span>
                <span class="rating" ng-if="mod.rating_avg > 0">★ {{ mod.rating_avg }}</span>
                <span class="filesize" ng-if="mod.filesize_display">{{ mod.filesize_display }}</span>
              </div>
            </div>
            

          </div>
        </div>

        <!-- Bottom Pagination for Selected Mods -->
        <div class="pagination-controls" ng-show="selectedModsTotalPages > 1">
          <button class="page-btn" ng-click="previousSelectedModsPage()" ng-disabled="selectedModsCurrentPage === 1">
            ← Previous
          </button>
          
          <span class="page-info">Page {{ selectedModsCurrentPage }} of {{ selectedModsTotalPages }}</span>
          
          <button class="page-btn" ng-click="nextSelectedModsPage()" ng-disabled="selectedModsCurrentPage === selectedModsTotalPages">
            Next →
          </button>
        </div>

        <!-- No Selected Mods -->
        <div class="no-mods-found" ng-show="getSelectedModCount() === 0">
          <p>No mods selected yet.</p>
          <p>Switch to the "Local Mods" or "Repository" tabs to select mods for your pack.</p>
        </div>

        <!-- Clear All Button -->
        <div class="selected-mods-actions" ng-show="getSelectedModCount() > 0">
          <button class="clear-selection-btn" ng-click="clearAllSelectedMods()">
            Clear All Selected Mods
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="footer-info">
        <span>{{ getSelectedModCount() }} mod{{ getSelectedModCount() !== 1 ? 's' : '' }} selected</span>
      </div>
      <div class="footer-actions">
        <button class="cancel-btn" ng-click="cancelCreatePack()">Cancel</button>
        <button class="create-btn" ng-click="createPack()" ng-disabled="!createPackForm.name || getSelectedModCount() === 0">
          {{ editingPack ? 'Update Pack' : 'Create Pack' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="delete-confirm-modal" ng-show="showDeleteConfirmModal">
  <div class="modal-backdrop" ng-click="cancelDelete()"></div>
  <div class="modal-content delete-confirm-content">
    <div class="modal-header">
      <h2>Delete Pack</h2>
      <button class="close-btn" ng-click="cancelDelete()">×</button>
    </div>

    <div class="modal-body">
      <div class="delete-confirm-message">
        <div class="warning-icon">⚠️</div>
        <h3>Are you sure you want to delete "{{ packToDelete.name }}"?</h3>
        <p>This action cannot be undone. The pack and all its settings will be permanently removed.</p>
      </div>
    </div>

    <div class="modal-footer">
      <div class="footer-actions">
        <button class="cancel-btn" ng-click="cancelDelete()">Cancel</button>
        <button class="delete-confirm-btn" ng-click="confirmDelete()">Delete Pack</button>
      </div>
    </div>
  </div>
</div>

<!-- Custom Mod Info Modal -->
<div class="mod-info-overlay" ng-show="showModInfoModal" ng-click="closeModInfo()">
  <div class="mod-info-modal" ng-click="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="mod-info-header">
      <h2>{{ selectedModInfo.title }}</h2>
      <button class="close-btn" ng-click="closeModInfo()">×</button>
    </div>
    
    <!-- Loading State -->
    <div class="mod-info-loading" ng-show="loadingModInfo">
      <p>Loading mod information...</p>
      <div class="loading-spinner"></div>
    </div>
    
    <!-- Mod Content -->
    <div class="mod-info-content" ng-show="!loadingModInfo && selectedModInfo">
      <!-- Two Column Layout -->
      <div class="mod-info-two-column">
        <!-- Left Column: Description Only -->
        <div class="mod-info-left-column">
          <div class="mod-info-description">
            <h3>Description</h3>
            <div class="description-content" ng-bind-html="selectedModInfo.message_parsed | trusted"></div>
          </div>
        </div>
        
        <!-- Right Column: All Mod Info -->
        <div class="mod-info-right-column">
          <!-- Mod Header Info -->
          <div class="mod-info-header-section">
            <div class="mod-info-icon">
              <img ng-src="{{ getModIcon(selectedModInfo) }}" 
                   onerror="this.src='/ui/modModules/repoManager/icons/default-mod-icon.png'">
            </div>
            
            <div class="mod-info-basic">
              <div class="mod-title">{{ selectedModInfo.title }}</div>
              <div class="mod-tagline">{{ selectedModInfo.tag_line }}</div>
              <div class="mod-author">By: {{ selectedModInfo.username }}</div>
              
              <!-- Rating -->
              <div class="mod-rating" ng-if="selectedModInfo.rating_avg > 0">
                <span class="stars">
                  <span ng-repeat="star in getStarArray(selectedModInfo.rating_avg) track by $index" 
                        class="star" ng-class="{'filled': star}">★</span>
                </span>
                <span class="rating-text">({{ selectedModInfo.rating_avg }}/5)</span>
              </div>
            </div>
          </div>
          
          <!-- Stats Section -->
          <div class="mod-info-stats">
            <div class="stat-item">
              <span class="stat-label">Downloads:</span>
              <span class="stat-value">{{ selectedModInfo.download_count }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">File Size:</span>
              <span class="stat-value">{{ selectedModInfo.filesize_display }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Version:</span>
              <span class="stat-value">{{ selectedModInfo.version_string }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Category:</span>
              <span class="stat-value">{{ selectedModInfo.category_title }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Last Updated:</span>
              <span class="stat-value">{{ selectedModInfo.last_update_formatted | date:'yyyy-MM-dd' }}</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Action Buttons -->
      <div class="mod-info-actions">
        <button class="action-btn primary" ng-click="selectModFromInfo()">
          {{ isRepoModSelected(selectedModInfo) ? 'Remove from Pack' : 'Add to Pack' }}
        </button>
        <button class="action-btn secondary" ng-click="closeModInfo()">Close</button>
      </div>
    </div>
  </div>
</div>