<link rel="stylesheet" type="text/css" href="/ui/modModules/repoManager/repoManager.css" />

<div class="repomanager-container">
  <div class="repomanager-header">
    <h2>Repo Manager</h2>
    <p>Manage your dependency packs and mods</p>

    <!-- Bulk action buttons in header -->
    <div class="header-buttons">
      <button class="header-install-btn" ng-click="installAllPacks()" ng-disabled="!hasPacksToInstall()">
        <span>Queue All Packs</span>
        <small>Start first pack and queue the rest</small>
      </button>
      <button class="header-uninstall-btn" ng-click="uninstallAllPacks()">
        <span>Deactivate All Packs</span>
        <small>Disable all dependency packs</small>
      </button>
    </div>
  </div>

  <div class="repomanager-content" ng-if="loading">
    <div class="loading-spinner">
      <p>Loading mod packs...</p>
    </div>
  </div>

  <!-- Scrollable Collections Grid -->
  <div class="collections-grid-container">
    <div class="repomanager-content" ng-if="!loading">
      <!-- Currently Downloading Section -->
      <div class="currently-downloading-section" ng-if="getCurrentlyDownloadingPack()">
        <div class="download-header">
          <h3>Currently Downloading</h3>
          <div class="download-pack-info">
            <span class="pack-name">{{getCurrentlyDownloadingPack() && getCurrentlyDownloadingPack().pack &&
              getCurrentlyDownloadingPack().pack.name}}</span>
            <span class="pack-progress">{{getCurrentProgressCount()}}/{{getCurrentlyDownloadingPack() &&
              getCurrentlyDownloadingPack().progress && getCurrentlyDownloadingPack().progress.totalMods}} mods</span>
          </div>
        </div>

        <div class="downloading-mods-grid"
          ng-if="currentDownloadPack && currentDownloadPack.progress && currentDownloadPack.progress.downloadingMods && currentDownloadPack.progress.downloadingMods.length > 0">
          <div class="downloading-mod-item" ng-repeat="mod in currentDownloadPack.progress.downloadingMods track by $index">
            <div class="mod-info-header">
              <span class="mod-name">{{getModDisplayName(mod)}}</span>
              <span class="mod-size">{{formatModFileSize(mod.dlnow)}}/{{formatModFileSize(mod.dltotal)}}</span>
            </div>
            <div class="mod-progress-container">
              <div class="mod-progress-bar-large">
                <div class="mod-progress-fill-large" ng-style="{'width': mod.progress + '%'}"></div>
              </div>
              <div class="mod-progress-percentage">{{mod.progress}}%</div>
            </div>
            <div class="mod-download-details" ng-if="mod.downloadSpeed > 0">
              <span class="download-speed">{{formatDownloadSpeed(mod.downloadSpeed)}}</span>
            </div>
          </div>
        </div>

        <div class="no-downloads-message" ng-if="shouldShowPreparingDownloads()">
          <p>{{getPreparingDownloadsMessage()}}</p>
        </div>



        <!-- Queue Display -->
        <div class="queue-display" ng-if="packQueue.length > 0">
          <div class="queue-header">
            <h4>Up Next</h4>
            <span class="queue-count">{{packQueue.length}} pack{{packQueue.length > 1 ? 's' : ''}} queued</span>
          </div>
          <div class="queue-items">
            <div class="queue-item" ng-repeat="queuedPackName in packQueue track by $index">
              <span class="queue-position">{{$index + 1}}.</span>
              <span class="queue-pack-name">{{(dependencies | filter:{packName: queuedPackName})[0] && (dependencies |
                filter:{packName: queuedPackName})[0].name || queuedPackName}}</span>
              <button class="remove-queue-btn"
                ng-click="removeFromQueue((dependencies | filter:{packName: queuedPackName})[0] && (dependencies | filter:{packName: queuedPackName})[0].id)"
                title="Remove from queue" ng-if="(dependencies | filter:{packName: queuedPackName})[0]">×</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Mod Sections -->
      <div class="mod-sections" ng-repeat="section in modSections">
        <div class="section-header" ng-click="toggleSection(section.modName)">
          <div class="section-title">
            <span class="section-arrow" ng-class="{'expanded': isSectionExpanded(section.modName)}">▶</span>
            <h3>{{ section.modName }}</h3>
            <span class="pack-count">({{ (section.packs | filter:{isCreatePack: '!true'}).length }} pack{{ (section.packs | filter:{isCreatePack: '!true'}).length !== 1 ? 's' : '' }})</span>
          </div>
          <div class="section-status">
            <span class="status-badge" ng-class="getSectionStatus(section).class">
              {{ getSectionStatus(section).text }}
            </span>
          </div>
        </div>
        
        <div class="section-actions" ng-if="isSectionExpanded(section.modName)">
          <button class="section-action-btn queue-all-btn" 
                  ng-click="queueAllPacksInSection(section)" 
                  ng-disabled="!canQueueSection(section)">
            Queue All Packs
          </button>
          <button class="section-action-btn deactivate-all-btn" 
                  ng-click="deactivateAllPacksInSection(section)" 
                  ng-disabled="!canDeactivateSection(section)">
            Deactivate All Packs
          </button>
        </div>
        
        <div class="collections-grid" ng-if="isSectionExpanded(section.modName)">
          <div class="collection-card" ng-repeat="pack in section.packs"
            ng-class="{'disabled': !enabledPacks[pack.id], 'downloading': currentPack === pack.packName}">
            <div class="card-image-container">
              <img ng-src="{{pack.imagePath}}" alt="{{pack.name}}" class="pack-image"
                onerror="this.src='/ui/modModules/repoManager/icons/repoManagerIcon.png'">
              <div class="pack-status" ng-class="getPackStatusState(pack).class">
                <span>{{getPackStatusState(pack).text}}</span>
              </div>

              <!-- Simple Progress Overlay -->
              <div class="progress-overlay" ng-if="currentPack === pack.packName">
                <div class="download-summary">
                  <div class="summary-text">
                    Downloading: {{getCurrentProgressCount()}}/{{packModCount}} mods
                  </div>
                </div>
              </div>
            </div>

            <div class="card-content">
              <div class="pack-header">
                <h3>{{ pack.name }}</h3>
                <div class="mod-count-container" ng-if="!pack.isCreatePack">
                  <span class="mod-count" ng-if="!packStatuses[pack.packName]">{{ pack.count }} mods</span>
                  <span class="mod-count pending"
                    ng-if="packStatuses[pack.packName] && packStatuses[pack.packName].isPending">
                    {{ packStatuses[pack.packName].totalCount }} mods pending
                  </span>
                  <span class="mod-count active"
                    ng-if="packStatuses[pack.packName] && !packStatuses[pack.packName].isPending && packStatuses[pack.packName].activeCount > 0">
                    {{ packStatuses[pack.packName].activeCount }}/{{ packStatuses[pack.packName].totalCount }} active
                  </span>
                  <span class="mod-count inactive"
                    ng-if="packStatuses[pack.packName] && !packStatuses[pack.packName].isPending && packStatuses[pack.packName].activeCount === 0">
                    0/{{ packStatuses[pack.packName].totalCount }} active
                  </span>
                </div>
              </div>

              <div class="pack-description">
                <p>{{pack.description}}</p>
              </div>

              <div class="pack-actions">
                <button ng-click="togglePack(pack)" class="toggle-btn" ng-class="getPackButtonState(pack).class"
                  ng-disabled="getPackButtonState(pack).disabled">
                  <span>{{getPackButtonState(pack).text}}</span>
                </button>
                
                <!-- Regular pack details button -->
                <button class="details-btn" ng-click="showPackDetails(pack)" ng-if="!pack.isCreatePack && !isCustomPack(pack)">Details</button>
                
                <!-- Custom pack management buttons -->
                <div ng-if="isCustomPack(pack)" class="custom-pack-actions">
                  <button class="edit-pack-btn" ng-click="editCustomPack(pack)" title="Edit Pack">
                    <span>Edit</span>
                  </button>
                  <button class="delete-pack-btn" ng-click="deleteCustomPack(pack)" title="Delete Pack">
                    <span>Delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="repomanager-buttons">
    <button ng-click="goBack()">Back to Main Menu</button>
  </div>
</div>

<!-- Pack Details Modal -->
<div class="pack-details-modal" ng-show="showDetailsModal">
  <div class="modal-backdrop" ng-click="closePackDetails()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>{{ selectedPack.name }} - Mod Details</h2>
      <button class="close-btn" ng-click="closePackDetails()">×</button>
    </div>

    <div class="modal-body">
      <div class="pack-info">
        <p><strong>Description:</strong> {{ selectedPack.description }}</p>
        <p><strong>Total Mods:</strong> {{ selectedPack.count }}</p>
        <p><strong>Showing:</strong> Page {{ currentPage }} of {{ totalPages }}</p>
      </div>

      <div class="loading-mods" ng-show="loadingPackDetails">
        <p>Loading mod details... ({{ loadedModsCount }}/{{ modsPerPage }})</p>
        <div class="loading-spinner"></div>
      </div>

      <!-- Pagination Controls -->
      <div class="pagination-controls" ng-show="!loadingPackDetails && totalPages > 1">
        <button class="page-btn" ng-click="previousPage()" ng-disabled="currentPage === 1">
          ← Previous
        </button>

        <div class="page-numbers">
          <span ng-repeat="page in [] | range:1:totalPages" class="page-number"
            ng-class="{active: page === currentPage}" ng-click="goToPage(page)">
            {{ page }}
          </span>
        </div>

        <button class="page-btn" ng-click="nextPage()" ng-disabled="currentPage === totalPages">
          Next →
        </button>
      </div>

      <div class="mods-grid" ng-show="!loadingPackDetails">
        <div class="mod-card" ng-repeat="mod in packModDetails">
          <div class="mod-image">
            <img ng-src="{{ mod.icon || '/ui/modModules/repoManager/icons/default-mod.png' }}"
              onerror="this.src='/ui/modModules/repoManager/icons/default-mod.png'; this.onerror=null; console.log('Image failed to load:', this.getAttribute('ng-src'));"
              onload="console.log('Image loaded successfully:', this.src)">
          </div>

          <div class="mod-info">
            <div class="mod-header">
              <h4>{{ mod.title }}</h4>
              <div class="mod-stats">
                <span class="filesize">{{ mod.filesize_display }}</span>
                <span class="downloads">{{ mod.downTxt }} <i class="icon-download"></i></span>
              </div>
            </div>

            <p class="mod-description">{{ mod.tag_line }}</p>

            <div class="mod-meta">
              <span class="author">By: {{ mod.author || 'Unknown' }}</span>
              <div class="rating" ng-if="mod.rating_avg > 0">
                <span class="stars">★</span>
                <span>{{ mod.rating_avg }}</span>
              </div>
            </div>

            <div class="mod-actions">
              <button class="mod-action-btn view-btn" ng-click="openModInRepo(mod)">
                View in Repo
              </button>

              <button class="mod-action-btn subscribe-btn" ng-if="!mod.sub && !mod.subscribed"
                ng-click="subscribeToMod(mod)">
                Subscribe
              </button>

              <button class="mod-action-btn unsubscribe-btn" ng-if="mod.sub || mod.subscribed"
                ng-click="unsubscribeFromMod(mod)">
                Unsubscribe
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Pack Modal -->
<div class="create-pack-modal" ng-show="showCreatePackModal">
  <div class="modal-backdrop" ng-click="cancelCreatePack()"></div>
  <div class="modal-content create-pack-content">
    <div class="modal-header">
      <h2>{{ editingPack ? 'Edit Custom Pack' : 'Create Custom Pack' }}</h2>
      <button class="close-btn" ng-click="cancelCreatePack()">×</button>
    </div>

    <div class="modal-body">
      <!-- Pack Information Form -->
      <div class="pack-form-section">
        <div class="form-group">
          <label for="packName">Pack Name *</label>
          <input type="text" id="packName" ng-model="createPackForm.name" placeholder="Enter pack name" maxlength="50" required>
        </div>
        
        <div class="form-group">
          <label for="packDescription">Description</label>
          <textarea id="packDescription" ng-model="createPackForm.description" placeholder="Enter pack description" maxlength="200"></textarea>
        </div>
        
        <div class="selected-mods-summary">
          <span class="selected-count">Selected Mods: {{ getSelectedModCount() }}</span>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading-mods" ng-show="loadingAllMods">
        <p>Loading available mods...</p>
        <div class="loading-spinner"></div>
      </div>

      <!-- Mod Selection -->
      <div class="mod-selection-section" ng-show="!loadingAllMods">
        <!-- Filter Input -->
        <div class="filter-section">
          <input type="text" ng-model="createPackFilter" ng-change="filterMods()" 
                 placeholder="Search mods by title, name, author, or ID..." class="filter-input">
          <span class="filter-results">{{ filteredMods.length }} mod{{ filteredMods.length !== 1 ? 's' : '' }} found</span>
        </div>

        <!-- Pagination for Mods -->
        <div class="pagination-controls" ng-show="createPackTotalPages > 1">
          <button class="page-btn" ng-click="previousCreatePackPage()" ng-disabled="createPackCurrentPage === 1">
            ← Previous
          </button>
          
          <span class="page-info">Page {{ createPackCurrentPage }} of {{ createPackTotalPages }}</span>
          
          <button class="page-btn" ng-click="nextCreatePackPage()" ng-disabled="createPackCurrentPage === createPackTotalPages">
            Next →
          </button>
        </div>

        <!-- Mods Grid -->
        <div class="create-pack-mods-grid">
          <div class="create-pack-mod-card" ng-repeat="mod in getPagedMods()" ng-class="{'selected': isModSelected(mod)}" ng-click="toggleModSelection(mod)">
            <div class="mod-selection-checkbox">
              <input type="checkbox" ng-checked="isModSelected(mod)" ng-click="$event.stopPropagation()">
            </div>
            
            <div class="mod-icon-container">
              <img ng-src="{{ mod.iconPath || '/ui/modModules/repoManager/icons/default-mod-icon.png' }}" 
                   class="mod-icon"
                   onerror="this.src='/ui/modModules/repoManager/icons/default-mod-icon.png'">
            </div>
            
            <div class="mod-basic-info">
              <div class="mod-name">{{ mod.title || mod.name || mod.modname }}</div>
              <div class="mod-author" ng-if="mod.author">By: {{ mod.author }}</div>
              <div class="mod-id">ID: {{ mod.tagid || mod.modname }}</div>
              <div class="mod-status" ng-class="{'active': mod.active, 'inactive': !mod.active}">
                {{ mod.active ? 'Active' : 'Inactive' }}
              </div>
            </div>
          </div>
        </div>

        <!-- No Mods Found -->
        <div class="no-mods-found" ng-show="filteredMods.length === 0 && !loadingAllMods">
          <p>No mods found matching your search criteria.</p>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <div class="footer-info">
        <span>{{ getSelectedModCount() }} mod{{ getSelectedModCount() !== 1 ? 's' : '' }} selected</span>
      </div>
      <div class="footer-actions">
        <button class="cancel-btn" ng-click="cancelCreatePack()">Cancel</button>
        <button class="create-btn" ng-click="createPack()" ng-disabled="!createPackForm.name || getSelectedModCount() === 0">
          {{ editingPack ? 'Update Pack' : 'Create Pack' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="delete-confirm-modal" ng-show="showDeleteConfirmModal">
  <div class="modal-backdrop" ng-click="cancelDelete()"></div>
  <div class="modal-content delete-confirm-content">
    <div class="modal-header">
      <h2>Delete Pack</h2>
      <button class="close-btn" ng-click="cancelDelete()">×</button>
    </div>

    <div class="modal-body">
      <div class="delete-confirm-message">
        <div class="warning-icon">⚠️</div>
        <h3>Are you sure you want to delete "{{ packToDelete.name }}"?</h3>
        <p>This action cannot be undone. The pack and all its settings will be permanently removed.</p>
      </div>
    </div>

    <div class="modal-footer">
      <div class="footer-actions">
        <button class="cancel-btn" ng-click="cancelDelete()">Cancel</button>
        <button class="delete-confirm-btn" ng-click="confirmDelete()">Delete Pack</button>
      </div>
    </div>
  </div>
</div>